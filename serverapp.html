<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Server Application &mdash; MonaServer 1 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.1.0/amelia/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/my-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="MonaServer 1 documentation" href="index.html" />

  <a href="https://github.com/MonaSolutions/MonaServer"
     class="visible-desktop hidden-xs"><img
    id="gh-banner"
    style="position: absolute; top: 50px; right: 0; border: 0;"
    src="_static/githubBlack.png"
    alt="Fork us on GitHub"></a>
  <script>
    // Adjust image position with banner height
    $(function () {
      var navHeight = $(".navbar .container").css("height");
      $("#gh-banner").css("top", navHeight);
    });
  </script>
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">


  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          MonaServer</a>
        <span class="navbar-text navbar-version pull-left"><b>1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
                <li><a href="quickstart.html"><img src="_static/star-bookmark-icone-8571-48.png"/> Quick Start</a></li>
                <li><a href="faq.html"><img src="_static/aide-point-interrogation-systeme-icone-8289-48.png"/> FAQ</a></li>
                <li><a href="contacts.html"><img src="_static/casque-ecoute-soutien-icone-9816-48.png"/> Services</a></li>
                <li><a href="roadmap.html"><img src="_static/time-system-preferences-icone-8704-48.png"/> Roadmap</a></li>
                <li><a href="manual.html"><img src="_static/texinfo-texte-x-icone-4685-48.png"/> Documentation</a></li>
            
            


            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="server-application">
<h1><a class="toc-backref" href="#id10">Server Application</a><a class="headerlink" href="#server-application" title="Permalink to this headline">¶</a></h1>
<p>MonaServer includes a powerfull script-engine (using <a class="reference external" href="http://www.lua.org/">LUA</a> langage) to create your own server applications. It allows to extend Mona behavior to add your specific needs in a flexible scripting-way.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#server-application" id="id10">Server Application</a><ul>
<li><a class="reference internal" href="#create-a-server-application" id="id11">Create a server application</a></li>
<li><a class="reference internal" href="#global-configurations" id="id12">Global configurations</a></li>
<li><a class="reference internal" href="#communication-between-server-applications" id="id13">Communication between server applications</a><ul>
<li><a class="reference internal" href="#application-inheritance" id="id14">Application inheritance</a></li>
<li><a class="reference internal" href="#exchange-between-unrelated-server-applications" id="id15">Exchange between unrelated server applications</a></li>
</ul>
</li>
<li><a class="reference internal" href="#communication-between-server-and-client" id="id16">Communication between server and client</a><ul>
<li><a class="reference internal" href="#pull-data-remote-procedure-call" id="id17">Pull data, Remote Procedure Call</a><ul>
<li><a class="reference internal" href="#remote-procedure-call-with-websocket-or-http" id="id18">Remote Procedure Call with Websocket or HTTP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-data" id="id19">Push data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lua-types-conversions" id="id20">LUA types conversions</a><ul>
<li><a class="reference internal" href="#amf-to-lua-conversions" id="id21">AMF to LUA conversions</a><ul>
<li><a class="reference internal" href="#custom-types" id="id22">Custom types</a></li>
</ul>
</li>
<li><a class="reference internal" href="#json-to-lua-conversions" id="id23">JSON to LUA conversions</a></li>
<li><a class="reference internal" href="#xml-rpc-to-lua-conversions" id="id24">XML-RPC to LUA conversions</a></li>
<li><a class="reference internal" href="#xml-data-compatibility-xml-parser" id="id25">XML data compatibility (XML parser)</a><ul>
<li><a class="reference internal" href="#a-sample-with-soap" id="id26">A sample with SOAP</a></li>
<li><a class="reference internal" href="#xml-to-lua-conversions" id="id27">XML to LUA conversions</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#lua-extensions-and-files-inclusion" id="id28">LUA extensions and files inclusion</a></li>
<li><a class="reference internal" href="#logs" id="id29">LOGS</a></li>
<li><a class="reference internal" href="#api" id="id30">API</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="create-a-server-application">
<h2><a class="toc-backref" href="#id11">Create a server application</a><a class="headerlink" href="#create-a-server-application" title="Permalink to this headline">¶</a></h2>
<p>On start, Mona creates a <em>www</em> folder in its root directory if it doesn&#8217;t exist already. In this space, you can create subfolders, each one of them describes one server application. When a client connects to MonaServer, the URL path relates the application to use.
For example, the address <em>rtmfp://host:port/myApplication</em> search its corresponding application in <em>MonaServer/www/myApplication</em> folder. First time MonaServer builds and executes the file <em>main.lua</em> presents in this folder. Then, on new comer, the application already built is executed, unless <em>main.lua</em> file has been modified since the last time. Indeed when you edit <em>main.lua</em> file, the corresponding application is rebuilt in a dynamic way, without having to restart the server.</p>
<div class="highlight-text"><div class="highlight"><pre>rtmfp://host:port/                   -&gt;     MonaServer/www/main.lua (root application)
rtmfp://host:port/myApplication      -&gt;     MonaServer/www/myApplication/main.lua
rtmfp://host:port/Games/myGame       -&gt;     MonaServer/www/Games/myGame/main.lua
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>The root application is built and started on MonaServer start, whereas other server applications are started on the first client connection.</li>
<li>Exceptionaly you can give root rights to a child application with the function <strong>children()</strong> as shown below. It permits to start other applications at start.</li>
</ul>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">children</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">childapp&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Each application is identified by its <em>path</em>, which is exactly the <em>path</em> part of the RTMFP URL connection. In the example above, <em>root application</em> has an empty string for path, then the both others have respectively <em>/myApplication</em> and <em>/Games/myGame</em> for <em>path</em> values.</p>
<p>Here a very simple first server application:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onStart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Server application &#39;&quot;</span><span class="o">..</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">&#39; started&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onStop</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Server application &#39;&quot;</span><span class="o">..</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">&#39; stopped&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="global-configurations">
<h2><a class="toc-backref" href="#id12">Global configurations</a><a class="headerlink" href="#global-configurations" title="Permalink to this headline">¶</a></h2>
<p><em>MonaServer.ini</em> file allows to give some global configuration values on MonaServer start-up (see <a class="reference external" href="./installation.html">Installation</a> page). To access for these values from script, use <em>mona.configs</em> property (see <em>Mona</em> object description in <a class="reference external" href="./api.html">Server Application, API</a> page to get more details). This system allows to create your own global configuration values and access to them in scripts.</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="c1">; MonaServer.ini file</span>
<span class="na">port</span><span class="o">=</span><span class="s">19350 ; existing config</span>
<span class="c1">; New custom config</span>
<span class="k">[myGroup]</span>
<span class="na">myConfig</span><span class="o">=</span><span class="s">test</span>
</pre></div>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- A script file</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mona</span><span class="p">.</span><span class="n">configs</span><span class="p">.</span><span class="n">port</span><span class="p">)</span> <span class="c1">-- displays &quot;19350&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mona</span><span class="p">.</span><span class="n">configs</span><span class="p">.</span><span class="n">myGroup</span><span class="p">.</span><span class="n">myConfig</span><span class="p">)</span> <span class="c1">-- displays &quot;test&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="communication-between-server-applications">
<h2><a class="toc-backref" href="#id13">Communication between server applications</a><a class="headerlink" href="#communication-between-server-applications" title="Permalink to this headline">¶</a></h2>
<p>One application can access (read or write) to a variable of one other application, and can call one function of one other application. But it goes much further than that, applications can be specialized, and inherit them, exactly like inheritance of classes.</p>
<div class="section" id="application-inheritance">
<h3><a class="toc-backref" href="#id14">Application inheritance</a><a class="headerlink" href="#application-inheritance" title="Permalink to this headline">¶</a></h3>
<p>Principle is simple, for example the <em>/Games/myGame</em> application extends the <em>/Games</em> application, and so all functions and variables available in <em>/Games/main.lua</em> are available in <em>/Games/myGame/main.lua</em>.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games script application</span>
<span class="n">test</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">I am Games&quot;</span>
</pre></div>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games/myGame script application</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="c1">-- displays &quot;I am Games&quot;</span>
</pre></div>
</div>
<p>You can overload an inherited variable or an inherited function, and even dynamically remove the overload if need in putting value to nil.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games/myGame script application</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>          <span class="c1">-- displays &quot;I am Games&quot;</span>
<span class="n">test</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">I am myGame&quot;</span> <span class="c1">-- overloads test variable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>          <span class="c1">-- displays &quot;I am myGame&quot;</span>
<span class="n">test</span> <span class="o">=</span> <span class="kc">nil</span>           <span class="c1">-- remove overloading test variable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>          <span class="c1">-- displays &quot;I am Games&quot;</span>
</pre></div>
</div>
<p>On variable overloading (or function overloading), you can always access for the parent version in prefixing with the parent application name.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games/myGame script application</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>          <span class="c1">-- displays &quot;I am Games&quot;</span>
<span class="n">test</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">I am myGame&quot;</span> <span class="c1">-- overloads test variable</span>
<span class="nb">print</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>          <span class="c1">-- displays &quot;I am myGame&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Games</span><span class="p">.</span><span class="n">test</span><span class="p">)</span>    <span class="c1">-- displays &quot;I am Games&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The root server application has for path an empty string.</p>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- &#39;/&#39; script application (the root server application)</span>
<span class="k">function</span> <span class="nf">hello</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">I am the root application&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games script application</span>
<span class="k">function</span> <span class="nf">hello</span><span class="p">()</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">I am /Games application&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">hello</span><span class="p">()</span> <span class="c1">-- displays &quot;I am /Games application&quot;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Events are functions called by the system (see <em>Events</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page), if an application doesn&#8217;t define <em>onConnection</em> event for example, on new client connection for this application, it&#8217;s the parent application which will receive the event. To avoid it, you have to overload the event in child application, and you can call also the parent version if needed.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The keyword <em>super</em> is supported to refer to the the parent application:</p>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games script application</span>
<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">super</span><span class="p">:</span><span class="n">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">super</span><span class="p">:</span><span class="n">hello</span><span class="p">()</span> <span class="c1">-- displays &quot;I am the root application&quot;</span>
</pre></div>
</div>
<p>You can use <em>client.path</em> property to check if it&#8217;s a client connected for this application or for one child application (see <a class="reference external" href="./api.html">Server Application, API</a> page for more details on <em>client</em> object description).</p>
</div>
<div class="section" id="exchange-between-unrelated-server-applications">
<h3><a class="toc-backref" href="#id15">Exchange between unrelated server applications</a><a class="headerlink" href="#exchange-between-unrelated-server-applications" title="Permalink to this headline">¶</a></h3>
<p>In class inheritance, parent class has no knowledge of its children. However, here a parent server application can access for an child variable or function in checking before its existence.
For example if <em>/Games</em> application would like to call a <em>load</em> function in <em>/Games/myGame</em> application, it have to check <em>myGame</em> existence, if <em>myGame</em> returns nil, it means that <em>myGame</em> doesn&#8217;t exist or is not yet started.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games script application</span>
<span class="k">if</span> <span class="n">myGame</span> <span class="k">then</span> <span class="n">myGame</span><span class="p">:</span><span class="nb">load</span><span class="p">()</span> <span class="k">end</span>
</pre></div>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games/myGame script application</span>
<span class="k">function</span> <span class="nf">load</span><span class="p">()</span> <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</pre></div>
</div>
<p>By the same way, any applications can do the same thing with any other applications, even without hierarchical relationship.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /myApplication script application</span>
<span class="k">if</span> <span class="n">Games</span> <span class="k">then</span>
  <span class="k">if</span> <span class="n">Games</span><span class="p">.</span><span class="n">myGame</span> <span class="k">then</span> <span class="n">Games</span><span class="p">.</span><span class="n">myGame</span><span class="p">:</span><span class="nb">load</span><span class="p">()</span> <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- /Games/myGame script application</span>
<span class="k">function</span> <span class="nf">load</span><span class="p">()</span> <span class="k">end</span>
  <span class="o">...</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="communication-between-server-and-client">
<h2><a class="toc-backref" href="#id16">Communication between server and client</a><a class="headerlink" href="#communication-between-server-and-client" title="Permalink to this headline">¶</a></h2>
<div class="section" id="pull-data-remote-procedure-call">
<h3><a class="toc-backref" href="#id17">Pull data, Remote Procedure Call</a><a class="headerlink" href="#pull-data-remote-procedure-call" title="Permalink to this headline">¶</a></h3>
<p>You have to define your RPC functions as a member of <em>client</em> object gotten on connection, its signature will be exactly the same on client and server side. It can take multiple parameters, and it can return one result.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">firstname</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="s">Hello &quot;</span><span class="o">..</span><span class="n">firstname</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> &quot;</span><span class="o">..</span><span class="n">name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>Flash client :</strong></p>
<div class="highlight-as3"><div class="highlight"><pre><span class="n">_netConnection</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="k">this</span>
<span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;test&quot;</span><span class="o">,</span><span class="k">new</span> <span class="kt">Responder</span><span class="o">(</span><span class="n">onResult</span><span class="o">,</span><span class="n">onStatus</span><span class="o">),</span><span class="s2">&quot;François-Marie&quot;</span><span class="o">,</span><span class="s2">&quot;Arouet&quot;</span><span class="o">)</span>

<span class="kd">function </span><span class="nf">close</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span> <span class="n">_netConnection</span><span class="o">.</span><span class="na">close</span><span class="o">()</span> <span class="o">}</span>
<span class="kd">function </span><span class="nf">onStatus</span><span class="o">(</span><span class="n">status</span><span class="o">:</span><span class="kt">Object</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
  <span class="nf">trace</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="na">description</span><span class="o">)</span>
<span class="o">}</span>

<span class="kd">function </span><span class="nf">onResult</span><span class="o">(</span><span class="n">response</span><span class="o">:</span><span class="kt">Object</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
  <span class="nf">trace</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="c1">// displays &quot;Hello François-Marie Arouet&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">When you change default client of NetConnection, the new client should have a <em>close()</em> method which closes the connection, because a RTMFP Server can call this function in some special cases</p>
</div>
<p>Note that returned result of the scripting function is a writing shortcut for:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">firstname</span><span class="p">)</span>
  <span class="n">client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeMessage</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Hello &quot;</span><span class="o">..</span><span class="n">firstname</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> &quot;</span><span class="o">..</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>They both make exactly the same thing.</p>
<p>If the function is not available on the <em>client</em> object, it returns a <em>NetConnection.Call.Failed</em> status event with <em>Method &#8216;test&#8217; not found</em> in description field. But you can also customize your own error event:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">test</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">firstname</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">firstname</span> <span class="k">then</span> <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">test function takes two arguments&quot;</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">return</span> <span class="s2">&quot;</span><span class="s">Hello &quot;</span><span class="o">..</span><span class="n">firstname</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> &quot;</span><span class="o">..</span><span class="n">name</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-as3"><div class="highlight"><pre><span class="n">_netConnection</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="k">this</span>
<span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;test&quot;</span><span class="o">,</span><span class="k">new</span> <span class="kt">Responder</span><span class="o">(</span><span class="n">onResult</span><span class="o">,</span><span class="n">onStatus</span><span class="o">),</span><span class="s2">&quot;François-Marie&quot;</span><span class="o">);</span>

<span class="kd">function </span><span class="nf">close</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span> <span class="n">_netConnection</span><span class="o">.</span><span class="na">close</span><span class="o">()</span> <span class="o">}</span>
<span class="kd">function </span><span class="nf">onStatus</span><span class="o">(</span><span class="n">status</span><span class="o">:</span><span class="kt">Object</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
  <span class="nf">trace</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="na">description</span><span class="o">)</span> <span class="c1">// displays &quot;..main.lua:3: test function takes two arguments&quot;</span>
<span class="o">}</span>
<span class="kd">function </span><span class="nf">onResult</span><span class="o">(</span><span class="n">response</span><span class="o">:</span><span class="kt">Object</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
  <span class="nf">trace</span><span class="o">(</span><span class="n">response</span><span class="o">)</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="remote-procedure-call-with-websocket-or-http">
<h4><a class="toc-backref" href="#id18">Remote Procedure Call with Websocket or HTTP</a><a class="headerlink" href="#remote-procedure-call-with-websocket-or-http" title="Permalink to this headline">¶</a></h4>
<p>Websocket supports JSON RPC and HTTP supports either JSON and <a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> using the &#8216;Content-Type&#8217; header. Here are samples using the same lua server part :</p>
<p><strong>Websocket client :</strong></p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onMessage</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;François-Marie&quot;</span><span class="p">,</span> <span class="s2">&quot;Arouet&quot;</span><span class="p">];</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>

<span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>HTTP JSON-RPC client :</strong></p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// Manage the response</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Send the POST request</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;François-Marie&quot;</span><span class="p">,</span> <span class="s2">&quot;Arouet&quot;</span><span class="p">];</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
</pre></div>
</div>
<p><strong>HTTP XML-RPC client :</strong></p>
<div class="highlight-js"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// Manage the response</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">response</span><span class="p">;</span>
    <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Send the POST request</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/xml&#39;</span><span class="p">);</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;&lt;methodCall&gt;&lt;methodName&gt;test&lt;/methodName&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;François-Marie&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;Arouet&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;&lt;/methodCall&gt;&quot;</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Here we use the <a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> format which is fully supported by Mona.</p>
</div>
<p>See more samples on <a class="reference external" href="./samples.html">Samples</a> page.</p>
</div>
</div>
<div class="section" id="push-data">
<h3><a class="toc-backref" href="#id19">Push data</a><a class="headerlink" href="#push-data" title="Permalink to this headline">¶</a></h3>
<p>Push data mechanism is either possible with Websocket and Flash using <em>client.writer</em> object.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onPushData&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">Rambo&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">John&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Flash client :</strong></p>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">function </span><span class="nf">onPushData</span><span class="o">(</span><span class="n">name</span><span class="o">:</span><span class="kt">String</span><span class="o">,</span><span class="n">firstName</span><span class="o">:</span><span class="kt">String</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
<span class="o">}</span>
</pre></div>
</div>
<p><strong>Websocket client :</strong></p>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onMessage</span><span class="p">;</span>
<span class="p">...</span>
<span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;onPushData&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="nx">firstName</span> <span class="o">=</span> <span class="nx">response</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Push data is not possible with HTTP protocol because it is an old protocol based on pull data only. Long polling is a solution for this but is not implemented yet.</p>
</div>
<p>Here an example of push data every two seconds (see <em>Events</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for <em>onManage</em> event description):</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">writers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">writers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">writer</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onDisconnection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="n">writers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onManage</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">client</span><span class="p">,</span><span class="n">writer</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">writers</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">refresh&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">function </span><span class="nf">refresh</span><span class="o">():</span><span class="kt">void</span> <span class="o">{...}</span>
</pre></div>
</div>
<p><em>client.writer</em> returns the main flowWriter of this client. A FlowWriter is an unidirectional communication pipe, which allows to write message in a fifo for the client. Each flowWriter has some statistic exchange informations.
When you want push a constant flow with a large amount of data, or if you want to get independant exchange statistics without disrupting the main flowWriter of one client, you can create your own flowWriter channel to push data:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">writers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">writers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">newFlowWriter</span><span class="p">()</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onDisconnection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="n">writers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onManage</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">client</span><span class="p">,</span><span class="n">writer</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">writers</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">refresh&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">function </span><span class="nf">refresh</span><span class="o">():</span><span class="kt">void</span> <span class="o">{...}</span>
</pre></div>
</div>
<p>When you create your own flowWriter, you can overload its <em>onManage</em> function, allowing you to write the same thing in a more elegant way, which avoid here <em>writers</em> table usage, and make the code really more short (see <em>Objects</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for more details).</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">writer</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">newFlowWriter</span><span class="p">()</span>
  <span class="k">function</span> <span class="nf">writer</span><span class="p">:</span><span class="n">onManage</span><span class="p">()</span>
    <span class="n">self</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">refresh&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">function </span><span class="nf">refresh</span><span class="o">():</span><span class="kt">void</span> <span class="o">{...}</span>
</pre></div>
</div>
<p>If you have need of pushing rate greater than two seconds, use <em>onRealTime</em> event of root application (see <em>Events</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for more details).</p>
</div>
</div>
<div class="section" id="lua-types-conversions">
<h2><a class="toc-backref" href="#id20">LUA types conversions</a><a class="headerlink" href="#lua-types-conversions" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>Several types are supported for messages received by server or sended to clients :</dt>
<dd><ul class="first last simple">
<li>AMF (for flash clients),</li>
<li>JSON,</li>
<li><a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a>,</li>
<li>XML (using the <em>fromXML</em> parser),</li>
<li>and raw data (obviously it does not needs conversion).</li>
</ul>
</dd>
</dl>
<div class="section" id="amf-to-lua-conversions">
<h3><a class="toc-backref" href="#id21">AMF to LUA conversions</a><a class="headerlink" href="#amf-to-lua-conversions" title="Permalink to this headline">¶</a></h3>
<p>Primitive conversion types are easy and intuitive (Number, Boolean, String). Except these primitive types, in <a class="reference external" href="http://www.lua.org/">LUA</a> all is table. Concerning AMF complex type conversions, things go as following:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- LUA table formatted in Object          // AMF Object</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span>          <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="n">width</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="n">height</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>

<span class="c1">-- LUA table formatted in Array           // AMF Array</span>
<span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                           <span class="n">new</span> <span class="n">Array</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

<span class="c1">-- LUA table mixed                       // AMF Array associative</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                      <span class="n">var</span> <span class="n">mixed</span><span class="p">:</span><span class="n">Array</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Array</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">);</span>
                                          <span class="n">mixed</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>  <span class="n">mixed</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">-- LUA table formatted in Dictionary     // AMF Dictionary</span>
<span class="p">{</span><span class="mi">10</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">test&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">test&quot;</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">__size</span><span class="o">=</span><span class="mi">2</span><span class="p">}</span>           <span class="n">var</span> <span class="n">dic</span><span class="p">:</span><span class="n">Dictionary</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Dictionary</span><span class="p">();</span>
                                          <span class="n">dic</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">test&quot;</span><span class="p">;</span>  <span class="n">dic</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">test&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="c1">-- LUA table formatted in ByteArray      // AMF ByteArray</span>
<span class="p">{</span><span class="n">__raw</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">rawdata&quot;</span><span class="p">}</span>                        <span class="n">var</span> <span class="n">data</span><span class="p">:</span><span class="n">ByteArray</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ByteArray</span><span class="p">();</span>
                                          <span class="n">data</span><span class="p">.</span><span class="n">writeUTFBytes</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">rawdata&quot;</span><span class="p">);</span>

<span class="c1">-- LUA Table formatted in date           // AMF Date</span>
<span class="p">{</span><span class="n">year</span><span class="o">=</span><span class="mi">1998</span><span class="p">,</span><span class="n">month</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span><span class="n">day</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span><span class="n">yday</span><span class="o">=</span><span class="mi">259</span><span class="p">,</span>      <span class="n">new</span> <span class="n">Date</span><span class="p">(</span><span class="mi">905989690435</span><span class="p">)</span>
<span class="n">wday</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span><span class="n">min</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span><span class="n">sec</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">msec</span><span class="o">=</span><span class="mi">435</span><span class="p">,</span>
<span class="n">isdst</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="n">__time</span><span class="o">=</span><span class="mi">905989690435</span><span class="p">}</span>
</pre></div>
</div>
<p>On a <a class="reference external" href="http://www.lua.org/">LUA</a> to AMF conversion, priortiy conversion order works as following:</p>
<p>1. If the LUA table given contains the property <em>__raw</em>, it&#8217;s converted to a ByteArray AMF object.
1. If the LUA table given contains the property <em>__size</em>, it&#8217;s converted to a Dictionary AMF object.
1. If the LUA table given contains the property <em>__time</em>, it&#8217;s converted to a Date AMF object.
1. Otherwise it chooses the more adapted conversion (Object, Array, or Array associative).</p>
<p>About <em>__time</em> property on a date object, it&#8217;s the the number of milliseconds elapsed since midnight UTC of January 1 1970 (<a class="reference external" href="http://en.wikipedia.org/wiki/Unix_time">Unix time</a>).</p>
<p>About Dictionary object, <a class="reference external" href="http://www.lua.org/">LUA</a> table supports an <a class="reference external" href="http://www.lua.org/pil/17.html">weak keys table</a> feature, and it&#8217;s used in AMF conversion with the <em>weakKeys</em> contructor argument of <a class="reference external" href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/utils/Dictionary.html">Dictionary AMF type</a>. It means that if you build an AMF Dictionary object with <em>weakKeys</em> equals <em>true</em> and send it to MonaServer, MonaServer converts it in a <a class="reference external" href="http://www.lua.org/">LUA</a> table with weak keys, and vice versa.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Actually Mona supports all AMF0 and AMF3 format, excepts <em>Vector</em> and <em>XML</em> types.</p>
</div>
<div class="section" id="custom-types">
<h4><a class="toc-backref" href="#id22">Custom types</a><a class="headerlink" href="#custom-types" title="Permalink to this headline">¶</a></h4>
<p>You can custom your object using typed object feature.
Indeed, when a typed object is unserialized, <em>onTypedObject</em> application event is called.</p>
<p>On client side, the AS3 class flag <em>RemoteClass</em> have to be added:</p>
<div class="highlight-as3"><div class="highlight"><pre><span class="o">[</span><span class="n">RemoteClass</span><span class="o">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;Cat&quot;</span><span class="o">)]</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="n">Cat</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">function </span><span class="nf">Cat</span> <span class="o">()</span> <span class="o">{</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">function </span><span class="nf">meow</span><span class="o">()</span> <span class="o">{</span>
    <span class="nf">trace</span><span class="o">(</span><span class="s2">&quot;meow&quot;</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>On reception of this type on script-server side, it will call our <em>onTypedObject</em> function, and you can custom your object:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onTypedObject</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;</span><span class="s">Cat&quot;</span> <span class="k">then</span>
    <span class="k">function</span> <span class="nf">object</span><span class="p">:</span><span class="n">meow</span><span class="p">()</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">meow&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><em>object</em> second argument contains a <em>__type</em> property, here equals to <em>&#8220;Cat&#8221;</em> (also equals to the first argument of <em>typeFactory</em> function). It means that if you want create a typed object from script-side, and send it to client, you have just to add a <em>__type</em> property.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">response</span><span class="p">:</span><span class="n">write</span><span class="p">({</span><span class="n">__type</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Cat&quot;</span><span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Cient will try to cast it in a <em>Cat</em> class.</p>
<p>You can go more further on this principle, and custom the AMF unserialization and serialization in adding __readExternal and __writeExternal function on the concerned object, it relates AS3 object which implements <em>IExternalizable</em> on client side (see <a class="reference external" href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/utils/IExternalizable.html">IExternalizable</a>).
For example, <em>ArrayCollection</em> is an externalizable type, and is not supported by default by the conversion system, you can add its support in adding this script code:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onTypedObject</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span><span class="n">object</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">type</span><span class="o">==</span><span class="s2">&quot;</span><span class="s">flex.messaging.io.ArrayCollection&quot;</span> <span class="k">then</span>
    <span class="k">function</span> <span class="nf">object</span><span class="p">:</span><span class="n">__readExternal</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">reader</span><span class="p">:</span><span class="n">readAMF</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">object</span><span class="p">:</span><span class="n">__writeExternal</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
      <span class="n">writer</span><span class="p">:</span><span class="n">writeAMF</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">source</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><em>reader</em> and <em>writer</em> arguments are equivalent of <a class="reference external" href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/utils/IDataOutput.html">IDataOutput</a> and <a class="reference external" href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/utils/IDataInput.html">IDataInput</a>) AS3 class (see <em>Objects</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for more details).</p>
</div>
</div>
<div class="section" id="json-to-lua-conversions">
<h3><a class="toc-backref" href="#id23">JSON to LUA conversions</a><a class="headerlink" href="#json-to-lua-conversions" title="Permalink to this headline">¶</a></h3>
<p>As in AMF primitive, conversion types are easy and intuitive (Number, Boolean, String). For the rest, things go as following:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- LUA table formatted in Object          // JSON Object</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span>          <span class="p">{</span><span class="s2">&quot;</span><span class="s">x&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">y&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">width&quot;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">height&quot;</span><span class="p">:</span><span class="mi">100</span><span class="p">}</span>

<span class="c1">-- LUA table formatted in Array           // JSON Array</span>
<span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                           <span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span>

<span class="c1">-- LUA table mixed                       // JSON Array + Object</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                      <span class="p">[{</span><span class="s2">&quot;</span><span class="s">x&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">y&quot;</span><span class="p">:</span><span class="mi">10</span><span class="p">},</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>Order can differ from original type because there is no attribute order in lua,</li>
<li>Notice that in JSON mixed tables don&#8217;t exist, that&#8217;s why we must create an Array with an object containing associative values,</li>
<li>For serializations reasons JSON data need to be encapsulated in a JSON array &#8216;[]&#8217;. For example the JSON Array above will be sended by client in this format :</li>
</ul>
</div>
<div class="highlight-js"><div class="highlight"><pre><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;[[10,10,100,100]]&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="xml-rpc-to-lua-conversions">
<h3><a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> to LUA conversions<a class="headerlink" href="#xml-rpc-to-lua-conversions" title="Permalink to this headline">¶</a></h3>
<p>There are a lot of XML format for communication, <a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> has been choosen for its simplicity and because it fits well with Mona.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- LUA table formatted in Object          // XML-RPC Object</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">}</span>          <span class="o">&lt;</span><span class="n">struct</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">x</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">y</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">width</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">height</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                          <span class="o">&lt;/</span><span class="n">struct</span><span class="o">&gt;</span>

<span class="c1">-- LUA table formatted in Array           // XML-RPC Array (size is facultative)</span>
<span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                           <span class="o">&lt;</span><span class="n">array</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">4&quot;</span><span class="o">&gt;</span>
                                            <span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">i4</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">i4</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
                                            <span class="o">&lt;/</span><span class="n">data</span><span class="o">&gt;</span>
                                          <span class="o">&lt;/</span><span class="n">array</span><span class="o">&gt;</span>

<span class="c1">-- LUA table mixed                        // XML-RPC Array + Object</span>
<span class="p">{</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}</span>                       <span class="o">&lt;</span><span class="n">array</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">3&quot;</span><span class="o">&gt;</span>
                                            <span class="o">&lt;</span><span class="n">data</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">struct</span><span class="o">&gt;</span>
                                                <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">y</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">int</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                                <span class="o">&lt;</span><span class="n">member</span><span class="o">&gt;&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="n">x</span><span class="o">&lt;/</span><span class="n">name</span><span class="o">&gt;&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&lt;/</span><span class="n">int</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;&lt;/</span><span class="n">member</span><span class="o">&gt;</span>
                                              <span class="o">&lt;/</span><span class="n">struct</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">int</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
                                              <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;&lt;</span><span class="n">int</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">int</span><span class="o">&gt;&lt;/</span><span class="n">value</span><span class="o">&gt;</span>
                                            <span class="o">&lt;/</span><span class="n">data</span><span class="o">&gt;</span>
                                          <span class="o">&lt;/</span><span class="n">array</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>As you see <a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> is a bit verbose so we council you to use JSON if possible for faster communication,</li>
<li>Order can differ from original type because there is no attribute order in lua,</li>
<li>Notice that in <a class="reference external" href="http://xmlrpc.scripting.com/spec.html">XML-RPC</a> mixed tables don&#8217;t exist, that&#8217;s why we must create an array with an object containing associative values.</li>
</ul>
</div>
</div>
<div class="section" id="xml-data-compatibility-xml-parser">
<h3><a class="toc-backref" href="#id25">XML data compatibility (XML parser)</a><a class="headerlink" href="#xml-data-compatibility-xml-parser" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, Mona traduce XMLRPC calls automatically. For other types of XML data only few <a class="reference external" href="http://www.lua.org/">LUA</a> code lines are needed, using the useful XML parser.</p>
<dl class="docutils">
<dt>Two methods are available to do this :</dt>
<dd><ul class="first last simple">
<li><em>fromXML</em></li>
<li>and <em>toXML</em></li>
</ul>
</dd>
</dl>
<p>See <em>Mona</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for more details.</p>
<div class="section" id="a-sample-with-soap">
<h4><a class="toc-backref" href="#id26">A sample with SOAP</a><a class="headerlink" href="#a-sample-with-soap" title="Permalink to this headline">¶</a></h4>
<p>Let us begin with an RPC addition method :</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">+</span><span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>We can already call this method by an HTTP GET request (the name and the parameters are given in the URI), a JSON POST, XML-RPC or by AMF.
But if we want absolutly to call it from a SOAP client with the following request :</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:xsd=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="na">xmlns:soap=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;soap:Body&gt;</span>
    <span class="nt">&lt;Add</span> <span class="na">xmlns=</span><span class="s">&quot;http://localhost/&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;Value&gt;</span>1<span class="nt">&lt;/Value&gt;</span>
    <span class="nt">&lt;/Add&gt;</span>
  <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span>
</pre></div>
</div>
<p>And the expected response :</p>
<div class="highlight-xml"><div class="highlight"><pre><span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:soap=</span><span class="s">&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:xsd=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;soap:Body&gt;</span>
    <span class="nt">&lt;AddResponse</span> <span class="na">xmlns=</span><span class="s">&quot;http://localhost/&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;AddResult&gt;</span>
        <span class="nt">&lt;Value&gt;</span>2<span class="nt">&lt;/Value&gt;</span>
      <span class="nt">&lt;/AddResult&gt;</span>
    <span class="nt">&lt;/AddResponse&gt;</span>
  <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span>
</pre></div>
</div>
<p>Just rebuild the <a class="reference external" href="http://www.lua.org/">LUA</a> code lines like this :</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onMessage</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">xml</span> <span class="o">=</span> <span class="n">mona</span><span class="p">:</span><span class="n">fromXML</span><span class="p">(</span><span class="nb">error</span><span class="p">,</span><span class="n">data</span><span class="p">)</span> <span class="c1">-- parse the XML data</span>

    <span class="c1">-- Call the method</span>
    <span class="kd">local</span> <span class="n">result</span> <span class="o">=</span> <span class="n">self</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">xml</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">soap:Envelope&quot;</span><span class="p">][</span><span class="s2">&quot;</span><span class="s">soap:Body&quot;</span><span class="p">].</span><span class="n">Add</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">__value</span><span class="p">)</span>

    <span class="c1">-- Replace the Add method by AddResult</span>
    <span class="kd">local</span> <span class="n">content</span> <span class="o">=</span> <span class="n">xml</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">soap:Envelope&quot;</span><span class="p">][</span><span class="s2">&quot;</span><span class="s">soap:Body&quot;</span><span class="p">].</span><span class="n">Add</span>
    <span class="n">content</span><span class="p">.</span><span class="n">__name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="s">AddResponse&quot;</span>
    <span class="n">content</span><span class="p">.</span><span class="n">__value</span> <span class="o">=</span> <span class="p">{</span><span class="n">__name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">AddResult&quot;</span><span class="p">,{</span><span class="n">__name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">Value&quot;</span><span class="p">,</span><span class="n">result</span><span class="p">}}</span>

    <span class="c1">-- Rewrite the XML data and send the result</span>
    <span class="k">return</span> <span class="n">mona</span><span class="p">:</span><span class="n">toXML</span><span class="p">(</span><span class="nb">error</span><span class="p">,</span><span class="n">xml</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">+</span><span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="xml-to-lua-conversions">
<h4><a class="toc-backref" href="#id27">XML to LUA conversions</a><a class="headerlink" href="#xml-to-lua-conversions" title="Permalink to this headline">¶</a></h4>
<p>The XML parser (fromXML/toXML) is freely inspirated by an <a class="reference external" href="https://github.com/lubyk/xml">open source project</a> to give an intuitive traduction of xml in lua variable.
Here is an example of xml to lua conversion :</p>
<p><strong>XML:</strong></p>
<div class="highlight-xml"><div class="highlight"><pre><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;document&gt;</span>
  <span class="nt">&lt;article&gt;</span>
    <span class="nt">&lt;p&gt;</span>This is the first paragraph.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;h2</span> <span class="na">class=</span><span class="s">&#39;opt&#39;</span><span class="nt">&gt;</span>Title with opt style<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;/article&gt;</span>
  <span class="nt">&lt;article&gt;</span>
    <span class="nt">&lt;p&gt;</span>Some <span class="nt">&lt;b&gt;</span>important<span class="nt">&lt;/b&gt;</span> text.<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;/article&gt;</span>
<span class="nt">&lt;/document&gt;</span>
</pre></div>
</div>
<p><strong>LUA:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span class="p">{</span> <span class="n">xml</span> <span class="o">=</span> <span class="p">{</span><span class="n">version</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">},</span>
  <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">document&#39;</span><span class="p">,</span>
    <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">article&#39;</span><span class="p">,</span>
      <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">This is the first paragraph.&#39;</span><span class="p">},</span>
      <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">h2&#39;</span><span class="p">,</span> <span class="n">class</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">opt&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Title with opt style&#39;</span><span class="p">},</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">article&#39;</span><span class="p">,</span>
      <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">p&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">Some &#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">__name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">b&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">important&#39;</span><span class="p">},</span> <span class="s1">&#39;</span><span class="s"> text.&#39;</span><span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>fromXML usage:</strong></p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">variable</span> <span class="o">=</span> <span class="n">mona</span><span class="p">:</span><span class="n">fromXML</span><span class="p">(</span><span class="n">XML</span><span class="p">)</span>
</pre></div>
</div>
<p>For facility you can access to <em>&#8220;This is the first paragraph&#8221;</em> by two ways :</p>
<ol class="arabic simple">
<li><em>variable[1][1][1][1]</em></li>
<li><em>variable.document.article.p.__value</em></li>
</ol>
</div>
</div>
</div>
<div class="section" id="lua-extensions-and-files-inclusion">
<h2><a class="toc-backref" href="#id28">LUA extensions and files inclusion</a><a class="headerlink" href="#lua-extensions-and-files-inclusion" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.lua.org/">LUA</a> can be extended easily, <a class="reference external" href="http://www.lua.org/">LUA</a> extensions can be founded for all needs and on all operating systems. With <a class="reference external" href="http://www.lua.org/">LUA</a> it is a common thing to add some new MonaServer abilities as SQL, TCP sockets, or others.
Install your <a class="reference external" href="http://www.lua.org/">LUA</a> extension library, and add a <em>require</em> line for your script. <a class="reference external" href="http://www.lua.org/">LUA</a> will search the extension in some common location related with <a class="reference external" href="http://www.lua.org/">LUA</a> folder installation.</p>
<p>Now if you need to organize your code in different directories for your server application, we have extended the <a class="reference external" href="http://www.lua.org/">LUA</a> functions <em>require</em>, <em>dofile</em> and <em>loadfile</em> (see <a class="reference external" href="http://www.lua.org/pil/8.html">this LUA page</a>) to allow inclusion through relative paths.
Search begin in the directory of the application itself and recursively in each parents applications. And finally, if the file cannot be found in this way it search in the common locations of <a class="reference external" href="http://www.lua.org/">LUA</a>.
So you can include your scripts like this :</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="kd">local</span> <span class="nb">module</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">module.lua&quot;</span><span class="p">)</span>
<span class="nb">require</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">init.lua&quot;</span><span class="p">)</span>

<span class="k">function</span> <span class="nf">onStart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="nb">dofile</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">start.lua&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">file</span> <span class="o">=</span> <span class="nb">loadfile</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">connection.lua&quot;</span><span class="p">)</span>
  <span class="nb">pcall</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Or you can always use <em>mona:absolutePath(path)</em> function (see <em>Objects</em> part of <a class="reference external" href="./api.html">Server Application, API</a> page for more details) if you want to use the absolute path of the file :</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onStart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="nb">dofile</span><span class="p">(</span><span class="n">mona</span><span class="p">:</span><span class="n">absolutePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">start.lua&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="nb">dofile</span><span class="p">(</span><span class="n">mona</span><span class="p">:</span><span class="n">absolutePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">connection.lua&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you edit an included file (like <em>start.lua</em> or <em>connection.lua</em> here), change are not taken as far as <em>dofile</em> is not called again or <em>main.lua</em> of this server application is not updated again.</p>
</div>
</div>
<div class="section" id="logs">
<h2><a class="toc-backref" href="#id29">LOGS</a><a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://www.lua.org/">LUA</a> <em>print</em> function writes text on the output console of MonaServer in a non-formatted way. Also, in service or daemon usage, nothing is printed of course.
The solution is to use logs macros :</p>
<ul class="simple">
<li><strong>ERROR</strong>, an error.</li>
<li><strong>WARN</strong>, a warning.</li>
<li><strong>NOTE</strong>, an important information, displayed by default in Mona log files.</li>
<li><strong>INFO</strong>, an information, displayed by default in Mona log files.</li>
<li><strong>DEBUG</strong>, displayed only if you start MonaServer with a more high level log (see <em>/help</em> or <em>&#8211;help</em> on command-line startup)</li>
<li><strong>TRACE</strong>, displayed only if you start MonaServer with a more high level log (see <em>/help</em> or <em>&#8211;help</em> on command-line startup)</li>
</ul>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onStart</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Application &quot;</span><span class="o">..</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> started&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onStop</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
  <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Application &quot;</span><span class="o">..</span><span class="n">path</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> stopped&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="api">
<h2><a class="toc-backref" href="#id30">API</a><a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h2>
<p>Complete API is available on <a class="reference external" href="./api.html">Server Application, API</a> page.</p>
</div>
</div>


    </div>
    
      
    
    

  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, Mathieu Poux &amp; Thomas Jammet.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>