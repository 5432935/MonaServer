<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Samples &mdash; MonaServer 1 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.1.0/cerulean/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/my-styles.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.1.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="MonaServer 1 documentation" href="index.html" />
    <link rel="next" title="Installation" href="installation.html" />
    <link rel="prev" title="Overview" href="index.html" />

  <a href="https://github.com/MonaSolutions/MonaServer"
     class="visible-desktop hidden-xs"><img
    id="gh-banner"
    style="position: absolute; top: 50px; right: 0; border: 0;"
    src="_static/githubBlack.png"
    alt="Fork us on GitHub"></a>
  <script>
    // Adjust image position with banner height
    $(function () {
      var navHeight = $(".navbar .container").css("height");
      $("#gh-banner").css("top", navHeight);
    });
  </script>

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          MonaServer</a>
        <span class="navbar-text navbar-version pull-left"><b>1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            <li class="divider-vertical"></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">Samples</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="serverapp.html">Server Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="scalability.html">Scalability and load-balancing</a></li>
<li class="toctree-l1"><a class="reference internal" href="serversocket.html">Server Application Sockets</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">Mona Server&#8217;s lua API</a></li>
<li class="toctree-l1"><a class="reference internal" href="protocols.html">Specific Protocol Functionalities</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">The MonaServer Database System</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Samples</a><ul>
<li><a class="reference internal" href="#pull-data">Pull Data</a><ul>
<li><a class="reference internal" href="#server-part-lua">Server part (lua)</a></li>
<li><a class="reference internal" href="#websocket-client">WebSocket client</a></li>
<li><a class="reference internal" href="#flash-client">Flash client</a></li>
<li><a class="reference internal" href="#http-client-json-rpc-and-xml-rpc">Http client (JSON-RPC and XML-RPC)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-data">Push Data</a><ul>
<li><a class="reference internal" href="#server-part">Server part</a></li>
<li><a class="reference internal" href="#id1">Websocket client</a></li>
<li><a class="reference internal" href="#id2">Flash client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-write-files">Read/Write Files</a></li>
<li><a class="reference internal" href="#communication-channels">Communication channels</a><ul>
<li><a class="reference internal" href="#publish-live">Publish live</a></li>
<li><a class="reference internal" href="#p2p-channel">P2P channel</a><ul>
<li><a class="reference internal" href="#id3">Server part</a></li>
<li><a class="reference internal" href="#id4">Flash client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#others">Others</a><ul>
<li><a class="reference internal" href="#meeting-sample">Meeting sample</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="index.html" title="Previous Chapter: Overview"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm">&laquo; Overview</span>
    </a>
  </li>
  <li>
    <a href="installation.html" title="Next Chapter: Installation"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm">Installation &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/samples.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <div class="section" id="samples">
<h1><a class="toc-backref" href="#id5">Samples</a><a class="headerlink" href="#samples" title="Permalink to this headline">¶</a></h1>
<p>This page gives you several examples of what you can do with MonaServer. Others samples are available in the <em>clients</em> directory of MonaServer. You can copy or create a symbolic link of this directory in <em>www</em>.
For more information about functionalities see <a class="reference external" href="./serverapp.html">Server Application</a> page.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#samples" id="id5">Samples</a><ul>
<li><a class="reference internal" href="#pull-data" id="id6">Pull Data</a><ul>
<li><a class="reference internal" href="#server-part-lua" id="id7">Server part (lua)</a></li>
<li><a class="reference internal" href="#websocket-client" id="id8">WebSocket client</a></li>
<li><a class="reference internal" href="#flash-client" id="id9">Flash client</a></li>
<li><a class="reference internal" href="#http-client-json-rpc-and-xml-rpc" id="id10">Http client (JSON-RPC and XML-RPC)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#push-data" id="id11">Push Data</a><ul>
<li><a class="reference internal" href="#server-part" id="id12">Server part</a></li>
<li><a class="reference internal" href="#id1" id="id13">Websocket client</a></li>
<li><a class="reference internal" href="#id2" id="id14">Flash client</a></li>
</ul>
</li>
<li><a class="reference internal" href="#read-write-files" id="id15">Read/Write Files</a></li>
<li><a class="reference internal" href="#communication-channels" id="id16">Communication channels</a><ul>
<li><a class="reference internal" href="#publish-live" id="id17">Publish live</a></li>
<li><a class="reference internal" href="#p2p-channel" id="id18">P2P channel</a><ul>
<li><a class="reference internal" href="#id3" id="id19">Server part</a></li>
<li><a class="reference internal" href="#id4" id="id20">Flash client</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#others" id="id21">Others</a><ul>
<li><a class="reference internal" href="#meeting-sample" id="id22">Meeting sample</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="pull-data">
<h2><a class="toc-backref" href="#id6">Pull Data</a><a class="headerlink" href="#pull-data" title="Permalink to this headline">¶</a></h2>
<p>This part describes how to write a simple pull data client/server that supports Websocket, Flash, and Http with RPC-type communication. The real amazing part is the 7 lines of server application which support each protocol :</p>
<div class="section" id="server-part-lua">
<h3><a class="toc-backref" href="#id7">Server part (lua)</a><a class="headerlink" href="#server-part-lua" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Connection of a new client &quot;</span><span class="o">..</span><span class="n">client</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span>
  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onMethod</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Reception Message : &quot;</span><span class="o">..</span><span class="n">mona</span><span class="p">:</span><span class="n">toJSON</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onReception&quot;</span><span class="p">,</span><span class="n">data</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> recieved&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="websocket-client">
<h3><a class="toc-backref" href="#id8">WebSocket client</a><a class="headerlink" href="#websocket-client" title="Permalink to this headline">¶</a></h3>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Pull Websocket/JSON Client Test<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
      <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">createWebSocket</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">host</span> <span class="o">=</span> <span class="s2">&quot;ws://&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">)</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
          <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;Your browser don&#39;t support webSocket!&quot;</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;socket opened&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;socket closed&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;An error occurs&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onMessage</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;onReception&quot;</span><span class="p">)</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;onMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;websocket msg&quot;</span><span class="p">];</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
      <span class="p">}</span>

      <span class="nx">createWebSocket</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">value=</span><span class="s">&quot;Send&quot;</span> <span class="na">onclick=</span><span class="s">&quot;sendMessage();&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;html&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="flash-client">
<h3><a class="toc-backref" href="#id9">Flash client</a><a class="headerlink" href="#flash-client" title="Permalink to this headline">¶</a></h3>
<div class="highlight-as3"><div class="highlight"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span> <span class="n">xmlns</span><span class="o">:</span><span class="n">fx</span><span class="o">=</span><span class="s2">&quot;http://ns.adobe.com/mxml/2009&quot;</span> <span class="n">xmlns</span><span class="o">:</span><span class="n">mx</span><span class="o">=</span><span class="s2">&quot;library://ns.adobe.com/flex/mx&quot;</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span> <span class="n">minWidth</span><span class="o">=</span><span class="s2">&quot;955&quot;</span> <span class="n">minHeight</span><span class="o">=</span><span class="s2">&quot;600&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
    <span class="o">&lt;![</span><span class="n">CDATA</span><span class="o">[</span>
      <span class="k">import</span> <span class="nn">mx.controls.Alert</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_netConnection</span><span class="p">:</span><span class="kt">NetConnection</span><span class="o">;</span>

  <span class="c1">// connect button handler</span>
  <span class="kd">private</span> <span class="kd">function </span><span class="nf">connectAndSend</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

    <span class="c1">// make a new NetConnection and connect</span>
    <span class="n">_netConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetConnection</span><span class="o">();</span>
    <span class="n">_netConnection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
    <span class="n">_netConnection</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="c1">// send the request</span>
    <span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;onMethod&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s2">&quot;amf message&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">function </span><span class="nf">onReception</span><span class="o">(</span><span class="n">result</span><span class="o">:</span><span class="kt">String</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span> <span class="n">Alert</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">result</span><span class="o">);</span> <span class="o">}</span>
    <span class="o">]]&gt;</span>
  <span class="o">&lt;/</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">TextInput</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;400&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;rtmfp://localhost/clients/pull&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;430&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Connect and Send&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;connectAndSend()&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="http-client-json-rpc-and-xml-rpc">
<h3><a class="toc-backref" href="#id10">Http client (JSON-RPC and XML-RPC)</a><a class="headerlink" href="#http-client-json-rpc-and-xml-rpc" title="Permalink to this headline">¶</a></h3>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;title&gt;</span>HTTP JSON Client Test<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">xmlhttp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
      <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

      <span class="c1">// Manage the response</span>
      <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;onReception&quot;</span><span class="p">)</span> <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="c1">// Send the POST request</span>
      <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;onMethod&quot;</span><span class="p">,</span> <span class="s2">&quot;http json msg&quot;</span><span class="p">];</span>
      <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">value=</span><span class="s">&quot;Send&quot;</span> <span class="na">onclick=</span><span class="s">&quot;sendMessage();&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;html&gt;</span>
</pre></div>
</div>
<p>Mona supports both json and xml formats, so just replace the response and request with the lines below to have xml http rpc sample :</p>
<div class="highlight-js"><div class="highlight"><pre><span class="c1">// Manage the response</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">roolElmt</span> <span class="o">=</span> <span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">roolElmt</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">textContent</span><span class="o">==</span><span class="s2">&quot;onReception&quot;</span><span class="p">)</span>
      <span class="nx">alert</span><span class="p">(</span><span class="nx">roolElmt</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">textContent</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Send the POST request</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/xml&#39;</span><span class="p">);</span>
<span class="nx">xmlhttp</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;&lt;__array&gt;&lt;__noname&gt;onMethod&lt;/__noname&gt;&lt;__noname&gt;http xml msg&lt;/__noname&gt;&lt;/__array&gt;&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="push-data">
<h2><a class="toc-backref" href="#id11">Push Data</a><a class="headerlink" href="#push-data" title="Permalink to this headline">¶</a></h2>
<p>This chapter presents an example of push client/server in Websocket and Flash (HTTP support only long polling method).
Brief description : When the flash client send a message to the server, this message is sent to the websocket client and conversely message from websocket is sent to the other client.</p>
<div class="section" id="server-part">
<h3><a class="toc-backref" href="#id12">Server part</a><a class="headerlink" href="#server-part" title="Permalink to this headline">¶</a></h3>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">clientWS</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="n">clientAMF</span> <span class="o">=</span> <span class="kc">nil</span>

<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>

  <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Connection of a new client to push (protocol:&quot;</span><span class="o">..</span><span class="n">client</span><span class="p">.</span><span class="n">protocol</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">)&quot;</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">client</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">WebSocket&quot;</span> <span class="k">then</span>
    <span class="n">clientWS</span> <span class="o">=</span> <span class="n">client</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="n">client</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">RTMFP&quot;</span> <span class="k">then</span>
      <span class="n">clientAMF</span> <span class="o">=</span> <span class="n">client</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onMessage</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Reception Message : &quot;</span><span class="o">..</span><span class="n">mona</span><span class="p">:</span><span class="n">toJSON</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">client</span> <span class="o">==</span> <span class="n">clientAMF</span> <span class="k">then</span>
      <span class="n">clientWS</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onReception&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">clientAMF</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onReception&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id13">Websocket client</a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>Push Websocket/JSON Client Test<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
      <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
      <span class="kd">function</span> <span class="nx">createWebSocket</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">host</span> <span class="o">=</span> <span class="s2">&quot;ws://&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">)</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">)</span> <span class="p">{</span>
          <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&quot;Your browser don&#39;t support webSocket!&quot;</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">host</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;socket opened&#39;</span><span class="p">);}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;socket closed&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">alert</span><span class="p">(</span><span class="s1">&#39;socket in error&#39;</span><span class="p">);</span> <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="nx">onMessage</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">onMessage</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;onReception&quot;</span><span class="p">)</span>
          <span class="nx">alert</span><span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; received&quot;</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">sendMessage</span><span class="p">()</span> <span class="p">{</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">([[</span><span class="s2">&quot;message from websocket&quot;</span><span class="p">]]);</span> <span class="p">}</span>

      <span class="nx">createWebSocket</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">value=</span><span class="s">&quot;Send&quot;</span> <span class="na">onclick=</span><span class="s">&quot;sendMessage();&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;html&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id14">Flash client</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="highlight-as3"><div class="highlight"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span> <span class="n">xmlns</span><span class="o">:</span><span class="n">fx</span><span class="o">=</span><span class="s2">&quot;http://ns.adobe.com/mxml/2009&quot;</span>
        <span class="n">xmlns</span><span class="o">:</span><span class="n">mx</span><span class="o">=</span><span class="s2">&quot;library://ns.adobe.com/flex/mx&quot;</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span> <span class="n">minWidth</span><span class="o">=</span><span class="s2">&quot;955&quot;</span> <span class="n">minHeight</span><span class="o">=</span><span class="s2">&quot;600&quot;</span> <span class="n">activate</span><span class="o">=</span><span class="s2">&quot;connect()&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
    <span class="o">&lt;![</span><span class="n">CDATA</span><span class="o">[</span>
      <span class="k">import</span> <span class="nn">mx.controls.Alert</span><span class="o">;</span>

      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_netConnection</span><span class="p">:</span><span class="kt">NetConnection</span><span class="o">;</span>

      <span class="c1">// connect button handler</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">connect</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

        <span class="c1">// make a new NetConnection and connect</span>
        <span class="n">_netConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetConnection</span><span class="o">();</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">send</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>
        <span class="c1">// send the request</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;onMessage&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s2">&quot;message from amf&quot;</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">function </span><span class="nf">onReception</span><span class="o">(</span><span class="n">result</span><span class="o">:</span><span class="kt">String</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span> <span class="n">Alert</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="n">result</span> <span class="o">+</span> <span class="s2">&quot; received&quot;</span><span class="o">);</span> <span class="o">}</span>
    <span class="o">]]&gt;</span>
  <span class="o">&lt;/</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">TextInput</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;400&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;rtmfp://localhost/clients/push&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;430&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Send&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;send()&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="read-write-files">
<h2><a class="toc-backref" href="#id15">Read/Write Files</a><a class="headerlink" href="#read-write-files" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="communication-channels">
<h2><a class="toc-backref" href="#id16">Communication channels</a><a class="headerlink" href="#communication-channels" title="Permalink to this headline">¶</a></h2>
<div class="section" id="publish-live">
<h3><a class="toc-backref" href="#id17">Publish live</a><a class="headerlink" href="#publish-live" title="Permalink to this headline">¶</a></h3>
<p>Now we are about to create a sample of publication with a flash publisher. For the server part just create a directory “publish” in the root directory. The client could be vlc for example connected to the url <a class="reference external" href="http://localhost/publish/file.flv">http://localhost/publish/file.flv</a>. for the publisher use the code below :</p>
<div class="highlight-as3"><div class="highlight"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span> <span class="n">xmlns</span><span class="o">:</span><span class="n">fx</span><span class="o">=</span><span class="s2">&quot;http://ns.adobe.com/mxml/2009&quot;</span>
        <span class="n">xmlns</span><span class="o">:</span><span class="n">mx</span><span class="o">=</span><span class="s2">&quot;library://ns.adobe.com/flex/mx&quot;</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span> <span class="n">minWidth</span><span class="o">=</span><span class="s2">&quot;955&quot;</span> <span class="n">minHeight</span><span class="o">=</span><span class="s2">&quot;600&quot;</span> <span class="n">activate</span><span class="o">=</span><span class="s2">&quot;startCam()&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
    <span class="o">&lt;![</span><span class="n">CDATA</span><span class="o">[</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_cam</span><span class="p">:</span><span class="kt">Camera</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_connection</span><span class="p">:</span><span class="kt">NetConnection</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_outstream</span><span class="p">:</span><span class="kt">NetStream</span><span class="o">;</span>

      <span class="c1">// init camera</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">startCam</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>
        <span class="n">_cam</span> <span class="o">=</span> <span class="n">Camera</span><span class="o">.</span><span class="na">getCamera</span><span class="o">();</span>
        <span class="n">player</span><span class="o">.</span><span class="na">attachCamera</span><span class="o">(</span><span class="n">_cam</span><span class="o">);</span>
        <span class="n">player</span><span class="o">.</span><span class="na">play</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="c1">// net status handler for the NetConnection : connect the netstream and publish</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">onStatus</span><span class="o">(</span><span class="n">evt</span><span class="o">:</span><span class="kt">NetStatusEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>

        <span class="n">status</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">code</span><span class="o">;</span>
        <span class="n">_outstream</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetStream</span><span class="o">(</span><span class="n">_connection</span><span class="o">);</span>
        <span class="n">_outstream</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">NetStatusEvent</span><span class="o">.</span><span class="na">NET_STATUS</span><span class="o">,</span> <span class="n">onStatusOutstream</span><span class="o">);</span>
        <span class="n">_outstream</span><span class="o">.</span><span class="na">attachCamera</span><span class="o">(</span><span class="n">_cam</span><span class="o">);</span>
        <span class="n">_outstream</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="s2">&quot;file&quot;</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// net status handler for the NetStream</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">onStatusOutstream</span><span class="o">(</span><span class="n">evt</span><span class="o">:</span><span class="kt">NetStatusEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
        <span class="n">statusOutstream</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">code</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// Connect</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">send</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

        <span class="n">_connection</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetConnection</span><span class="o">();</span>
        <span class="n">_connection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">text</span><span class="o">);</span>
        <span class="n">_connection</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">NetStatusEvent</span><span class="o">.</span><span class="na">NET_STATUS</span><span class="o">,</span> <span class="n">onStatus</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">]]&gt;</span>
  <span class="o">&lt;/</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">TextInput</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;400&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;rtmfp://localhost/publish&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;450&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Send&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;send()&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Label</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;40&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Net Status Code: &quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Text</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;150&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;40&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;status&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Label</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;70&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;OutStream Status Code: &quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Text</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;150&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;70&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;statusOutstream&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">VideoDisplay</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;100&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;160&quot;</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;120&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;player&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="p2p-channel">
<h3><a class="toc-backref" href="#id18">P2P channel</a><a class="headerlink" href="#p2p-channel" title="Permalink to this headline">¶</a></h3>
<p>This sample shows P2P file transfert and NetGroup usage over Object Replication functionality.</p>
<div class="section" id="id3">
<h4><a class="toc-backref" href="#id19">Server part</a><a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>Source below is the lua application. During the test you should take attention to the sender of the file which could be any peer among the providers.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">peers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

  <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User connected on p2p sharing app : &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="n">peers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onInfoSend</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>

    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User &quot;</span><span class="o">..</span><span class="n">peers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> is sending file &quot;</span><span class="o">..</span><span class="n">file</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> (&quot;</span><span class="o">..</span><span class="n">index</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">)&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onInfoRequest</span><span class="p">()</span>

    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User &quot;</span><span class="o">..</span><span class="n">peers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> has requested file&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onDisconnection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">peers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">name</span> <span class="k">then</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User disconnecting: &quot;</span><span class="o">..</span><span class="n">name</span><span class="p">)</span>
    <span class="n">peers</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h4><a class="toc-backref" href="#id20">Flash client</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>And the flash client source is cutted in three files.
Here is the file <em>P2PSharedObject.as</em>, the class file for objects that will be exchanged :</p>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">package</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">flash.utils.ByteArray</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="n">P2PSharedObject</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">var</span> <span class="n">fileName</span><span class="p">:</span><span class="kt">String</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">size</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">packetLength</span><span class="p">:</span><span class="kt">uint</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">actualFetchIndex</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">data</span><span class="p">:</span><span class="kt">ByteArray</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">chunks</span><span class="p">:</span><span class="kt">Object</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">function </span><span class="nf">P2PSharedObject</span><span class="o">(){}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Next file is <em>LocalFileLoader.As</em>, the class for reading files and chunking them :</p>
<div class="highlight-as3"><div class="highlight"><pre><span class="kd">package</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">flash.events.Event</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.events.EventDispatcher</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.events.IOErrorEvent</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.events.ProgressEvent</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.events.SecurityErrorEvent</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.events.StatusEvent</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.net.FileReference</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">flash.utils.ByteArray</span><span class="o">;</span>
  <span class="k">import</span> <span class="nn">mx.controls.Alert</span><span class="o">;</span>

  <span class="o">[</span><span class="n">Event</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="o">,</span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;flash.events.Event&quot;</span><span class="o">)]</span>
  <span class="o">[</span><span class="n">Event</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="o">,</span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;flash.events.StatusEvent&quot;</span><span class="o">)]</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="n">LocalFileLoader</span> <span class="kd">extends</span> <span class="n">EventDispatcher</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">function </span><span class="nf">LocalFileLoader</span><span class="o">(){}</span>

    <span class="kd">private</span> <span class="kd">var</span> <span class="n">file</span><span class="p">:</span><span class="kt">FileReference</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">var</span> <span class="n">p2pSharedObject</span><span class="p">:</span><span class="kt">P2PSharedObject</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">const</span> <span class="n">SIZE_CHUNKS</span><span class="p">:</span><span class="kt">Number</span><span class="o">=</span><span class="mi">64000</span><span class="o">;</span> <span class="c1">///&lt; 64k per chunks</span>

    <span class="kd">public</span> <span class="kd">function </span><span class="nf">browseFileSystem</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

      <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">FileReference</span><span class="o">();</span>
      <span class="n">file</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">SELECT</span><span class="o">,</span> <span class="n">selectHandler</span><span class="o">);</span>
      <span class="n">file</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">IOErrorEvent</span><span class="o">.</span><span class="na">IO_ERROR</span><span class="o">,</span> <span class="n">ioErrorHandler</span><span class="o">);</span>
      <span class="n">file</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">ProgressEvent</span><span class="o">.</span><span class="na">PROGRESS</span><span class="o">,</span> <span class="n">progressHandler</span><span class="o">);</span>
      <span class="n">file</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">SecurityErrorEvent</span><span class="o">.</span><span class="na">SECURITY_ERROR</span><span class="o">,</span> <span class="n">securityErrorHandler</span><span class="o">)</span>
      <span class="n">file</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">COMPLETE</span><span class="o">,</span> <span class="n">completeHandler</span><span class="o">);</span>
      <span class="n">file</span><span class="o">.</span><span class="na">browse</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">selectHandler</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
      <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;fileChosen : &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">name</span><span class="o">+</span><span class="s2">&quot; | &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">size</span><span class="o">);</span>
      <span class="n">file</span><span class="o">.</span><span class="na">load</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">ioErrorHandler</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">IOErrorEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
      <span class="n">Alert</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="s2">&quot;ioErrorHandler: &quot;</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">securityErrorHandler</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">SecurityErrorEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
      <span class="n">Alert</span><span class="o">.</span><span class="na">show</span><span class="o">(</span><span class="s2">&quot;securityError: &quot;</span> <span class="o">+</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">progressHandler</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">ProgressEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
      <span class="kd">var</span> <span class="n">file</span><span class="p">:</span><span class="kt">FileReference</span> <span class="o">=</span> <span class="n">FileReference</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">target</span><span class="o">);</span>
      <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;progressHandler: bytesLoaded=&quot;</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">bytesLoaded</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span><span class="n">event</span><span class="o">.</span><span class="na">bytesTotal</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">completeHandler</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
      <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;completeHandler&quot;</span><span class="o">);</span>

      <span class="n">p2pSharedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">P2PSharedObject</span><span class="o">();</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">size</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">size</span><span class="o">;</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">data</span><span class="o">;</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">name</span><span class="o">;</span>

      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Object</span><span class="o">();</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

      <span class="c1">// Write each chunked part of file</span>
      <span class="kd">var</span> <span class="n">size</span><span class="p">:</span><span class="kt">Number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="k">while</span><span class="o">((</span><span class="n">size</span> <span class="o">=</span> <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">bytesAvailable</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>

        <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">ByteArray</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">SIZE_CHUNKS</span><span class="o">)</span>
          <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">],</span><span class="mi">0</span><span class="o">,</span><span class="n">SIZE_CHUNKS</span><span class="o">);</span>
        <span class="k">else</span> <span class="c1">// last bytes</span>
          <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">],</span><span class="mi">0</span><span class="o">,</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">bytesAvailable</span><span class="o">);</span>
        <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">;</span>
      <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span><span class="o">;</span>

      <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;packetLength: &quot;</span><span class="o">+(</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">));</span>
      <span class="n">dispatchEvent</span><span class="o">(</span><span class="k">new</span> <span class="kt">Event</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">COMPLETE</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">function </span><span class="nf">writeText</span><span class="o">(</span><span class="n">str</span><span class="o">:</span><span class="kt">String</span><span class="o">):</span><span class="kt">void</span><span class="o">{</span>
      <span class="kd">var</span> <span class="n">e</span><span class="p">:</span><span class="kt">StatusEvent</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">StatusEvent</span><span class="o">(</span><span class="n">StatusEvent</span><span class="o">.</span><span class="na">STATUS</span><span class="o">,</span><span class="kc">false</span><span class="o">,</span><span class="kc">false</span><span class="o">,</span><span class="s2">&quot;status&quot;</span><span class="o">,</span><span class="n">str</span><span class="o">);</span>

      <span class="n">dispatchEvent</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>And the last one is the mxml main file which connect the peer to MonaServer and share/receive file among the peers :</p>
<div class="highlight-as3"><div class="highlight"><pre><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">?&gt;</span>
<span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span> <span class="n">xmlns</span><span class="o">:</span><span class="n">fx</span><span class="o">=</span><span class="s2">&quot;http://ns.adobe.com/mxml/2009&quot;</span>
        <span class="n">xmlns</span><span class="o">:</span><span class="n">mx</span><span class="o">=</span><span class="s2">&quot;library://ns.adobe.com/flex/mx&quot;</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span> <span class="n">minWidth</span><span class="o">=</span><span class="s2">&quot;955&quot;</span> <span class="n">minHeight</span><span class="o">=</span><span class="s2">&quot;600&quot;</span> <span class="n">applicationComplete</span><span class="o">=</span><span class="s2">&quot;getName();&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
    <span class="o">&lt;![</span><span class="n">CDATA</span><span class="o">[</span>
      <span class="k">import</span> <span class="nn">mx.containers.TitleWindow</span><span class="o">;</span>
      <span class="k">import</span> <span class="nn">mx.events.CloseEvent</span><span class="o">;</span>
      <span class="k">import</span> <span class="nn">mx.managers.PopUpManager</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_fileLoader</span><span class="p">:</span><span class="kt">LocalFileLoader</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_netConnection</span><span class="p">:</span><span class="kt">NetConnection</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_netGroup</span><span class="p">:</span><span class="kt">NetGroup</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_namePopup</span><span class="p">:</span><span class="kt">TitleWindow</span><span class="o">;</span>
      <span class="kd">private</span> <span class="kd">var</span> <span class="n">_nameUser</span><span class="p">:</span><span class="kt">String</span><span class="o">;</span>
      <span class="kd">public</span>  <span class="kd">var</span> <span class="n">p2pSharedObject</span><span class="p">:</span><span class="kt">P2PSharedObject</span><span class="o">;</span>

      <span class="c1">//////////////////////////// IDENTIFICATION ////////////////////////////////</span>

      <span class="c1">// Try to identificate</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">sendName</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>

        <span class="c1">// Accept only &lt;ENTER&gt; key</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">event</span> <span class="k">is</span> <span class="n">KeyboardEvent</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">var</span> <span class="n">eventKey</span><span class="p">:</span><span class="kt">KeyboardEvent</span> <span class="o">=</span> <span class="n">event</span> <span class="k">as</span> <span class="n">KeyboardEvent</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">eventKey</span><span class="o">.</span><span class="na">keyCode</span> <span class="o">!=</span> <span class="mi">13</span><span class="o">)</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">var</span> <span class="n">userName</span><span class="p">:</span><span class="kt">TextInput</span> <span class="o">=</span> <span class="n">_namePopup</span><span class="o">.</span><span class="na">getChildByName</span><span class="o">(</span><span class="s2">&quot;userName&quot;</span><span class="o">)</span> <span class="k">as</span> <span class="n">TextInput</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">userName</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">userName</span><span class="o">.</span><span class="na">text</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">{</span>

          <span class="n">_nameUser</span> <span class="o">=</span> <span class="n">userName</span><span class="o">.</span><span class="na">text</span><span class="o">;</span>
          <span class="n">PopUpManager</span><span class="o">.</span><span class="na">removePopUp</span><span class="o">(</span><span class="n">_namePopup</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">closeNamePopup</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">CloseEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>

        <span class="n">PopUpManager</span><span class="o">.</span><span class="na">removePopUp</span><span class="o">(</span><span class="n">_namePopup</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// net status handler for the NetConnection</span>
      <span class="kd">private</span> <span class="kd">function </span><span class="nf">getName</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

        <span class="c1">// create and configure the Identification Window</span>
        <span class="n">_namePopup</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">TitleWindow</span><span class="o">();</span>
        <span class="n">_namePopup</span><span class="o">.</span><span class="na">title</span> <span class="o">=</span> <span class="s2">&quot;Please enter your name :&quot;</span><span class="o">;</span>
        <span class="n">_namePopup</span><span class="o">.</span><span class="na">showCloseButton</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="n">_namePopup</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">CloseEvent</span><span class="o">.</span><span class="na">CLOSE</span><span class="o">,</span> <span class="n">closeNamePopup</span><span class="o">);</span>

        <span class="c1">// create and configure a Label</span>
        <span class="kd">var</span> <span class="n">userName</span><span class="p">:</span><span class="kt">TextInput</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">TextInput</span><span class="o">();</span>
        <span class="n">userName</span><span class="o">.</span><span class="na">text</span> <span class="o">=</span> <span class="s2">&quot;User&quot;</span><span class="o">;</span>
        <span class="n">userName</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="s2">&quot;userName&quot;</span><span class="o">;</span>
        <span class="n">_namePopup</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">userName</span><span class="o">);</span>
        <span class="c1">// add buttons OK and Cancel</span>
        <span class="kd">var</span> <span class="n">btOK</span><span class="p">:</span><span class="kt">Button</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Button</span><span class="o">();</span>
        <span class="n">btOK</span><span class="o">.</span><span class="na">label</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span><span class="o">;</span>
        <span class="n">btOK</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">MouseEvent</span><span class="o">.</span><span class="na">CLICK</span><span class="o">,</span> <span class="n">sendName</span><span class="o">);</span>
        <span class="n">btOK</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">KeyboardEvent</span><span class="o">.</span><span class="na">KEY_DOWN</span><span class="o">,</span> <span class="n">sendName</span><span class="o">);</span>
        <span class="n">_namePopup</span><span class="o">.</span><span class="na">addChild</span><span class="o">(</span><span class="n">btOK</span><span class="o">);</span>

        <span class="c1">// open the Identification Window as a modal popup window</span>
        <span class="n">PopUpManager</span><span class="o">.</span><span class="na">addPopUp</span><span class="o">(</span><span class="n">_namePopup</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
        <span class="n">PopUpManager</span><span class="o">.</span><span class="na">centerPopUp</span><span class="o">(</span><span class="n">_namePopup</span><span class="o">);</span>
        <span class="n">userName</span><span class="o">.</span><span class="na">setFocus</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="c1">//////////////////////////// CONNECTION ////////////////////////////////</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">connect</span><span class="o">():</span><span class="kt">void</span><span class="o">{</span>
        <span class="n">_fileLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">LocalFileLoader</span><span class="o">();</span>
        <span class="n">_fileLoader</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">StatusEvent</span><span class="o">.</span><span class="na">STATUS</span><span class="o">,</span> <span class="n">onStatusLoad</span><span class="o">);</span>
        <span class="n">_fileLoader</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">Event</span><span class="o">.</span><span class="na">COMPLETE</span><span class="o">,</span> <span class="n">startSharing</span><span class="o">);</span>

        <span class="n">_netConnection</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetConnection</span><span class="o">();</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">NetStatusEvent</span><span class="o">.</span><span class="na">NET_STATUS</span><span class="o">,</span> <span class="n">netStatus</span><span class="o">);</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">address</span><span class="o">.</span><span class="na">text</span><span class="o">,</span> <span class="n">_nameUser</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">onStatusLoad</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">StatusEvent</span><span class="o">):</span><span class="kt">void</span><span class="o">{</span>
        <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;Load : &quot;</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">level</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">//////////////////////////// TRANSFERT ////////////////////////////////</span>

      <span class="kd">protected</span> <span class="kd">function </span><span class="nf">netStatus</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">NetStatusEvent</span><span class="o">):</span><span class="kt">void</span><span class="o">{</span>

        <span class="k">switch</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">code</span><span class="o">){</span>
          <span class="k">case</span> <span class="s2">&quot;NetConnection.Connect.Success&quot;</span><span class="o">:</span> <span class="c1">// Connected to server =&gt; NetGroup connection</span>
            <span class="kd">var</span> <span class="n">spec</span><span class="p">:</span><span class="kt">GroupSpecifier</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">GroupSpecifier</span><span class="o">(</span><span class="s2">&quot;myGroup&quot;</span><span class="o">);</span>
            <span class="n">spec</span><span class="o">.</span><span class="na">serverChannelEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">spec</span><span class="o">.</span><span class="na">objectReplicationEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

            <span class="n">_netGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">NetGroup</span><span class="o">(</span><span class="n">_netConnection</span><span class="o">,</span><span class="n">spec</span><span class="o">.</span><span class="na">groupspecWithAuthorizations</span><span class="o">());</span>
            <span class="n">_netGroup</span><span class="o">.</span><span class="na">addEventListener</span><span class="o">(</span><span class="n">NetStatusEvent</span><span class="o">.</span><span class="na">NET_STATUS</span><span class="o">,</span><span class="n">netStatus</span><span class="o">);</span>

            <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;Netconnection OK&quot;</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

          <span class="k">case</span> <span class="s2">&quot;NetGroup.Connect.Success&quot;</span><span class="o">:</span> <span class="c1">// Connected to group</span>
            <span class="n">_netGroup</span><span class="o">.</span><span class="na">replicationStrategy</span> <span class="o">=</span> <span class="n">NetGroupReplicationStrategy</span><span class="o">.</span><span class="na">LOWEST_FIRST</span><span class="o">;</span>
            <span class="n">btStartReceiving</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">btBrowse</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;NetGroup Connection OK&quot;</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>

          <span class="k">case</span> <span class="s2">&quot;NetGroup.Replication.Fetch.Result&quot;</span><span class="o">:</span> <span class="c1">// Reception of file</span>

            <span class="c1">// Share the chunk downloaded</span>
            <span class="n">_netGroup</span><span class="o">.</span><span class="na">addHaveObjects</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">,</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">);</span>
            <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">object</span><span class="o">;</span>
            <span class="n">_fileLoader</span><span class="o">.</span><span class="na">p2pSharedObject</span> <span class="o">=</span> <span class="n">p2pSharedObject</span><span class="o">;</span>

            <span class="c1">// Size</span>
            <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
              <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span> <span class="o">=</span> <span class="n">Number</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
              <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;p2pSharedObject.packetLenght: &quot;</span><span class="o">+</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// FileName</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">String</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">object</span><span class="o">);</span>
              <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;p2pSharedObject.fileName: &quot;</span><span class="o">+</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// File Reception Complete!</span>
            <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;Receiving DONE: &quot;</span><span class="o">+</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">);</span>

              <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">ByteArray</span><span class="o">();</span>
              <span class="k">for</span><span class="o">(</span><span class="kd">var</span> <span class="n">i</span><span class="p">:</span><span class="kt">int</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
              <span class="o">}</span>
              <span class="n">btSave</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">receiveObject</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>

            <span class="k">break</span><span class="o">;</span>

          <span class="k">case</span> <span class="s2">&quot;NetGroup.Replication.Request&quot;</span><span class="o">:</span> <span class="c1">// File requested</span>
            <span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;onInfoSend&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">_fileLoader</span><span class="o">.</span><span class="na">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">);</span>
            <span class="n">_netGroup</span><span class="o">.</span><span class="na">writeRequestedObject</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">requestID</span><span class="o">,</span> <span class="n">_fileLoader</span><span class="o">.</span><span class="na">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span><span class="o">[</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">index</span><span class="o">]);</span>
            <span class="k">break</span><span class="o">;</span>

          <span class="k">case</span> <span class="s2">&quot;NetGroup.Replication.Fetch.SendNotify&quot;</span><span class="o">:</span>
            <span class="k">break</span><span class="o">;</span>

          <span class="k">default</span><span class="o">:</span>
            <span class="n">writeText</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">code</span><span class="o">);</span>
            <span class="k">break</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">saveFile</span><span class="o">():</span><span class="kt">void</span> <span class="o">{</span>

        <span class="kd">var</span> <span class="n">file</span><span class="p">:</span><span class="kt">FileReference</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">FileReference</span><span class="o">();</span>
        <span class="n">file</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">data</span><span class="o">,</span> <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">fileName</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Request one chunked object</span>
      <span class="kd">protected</span> <span class="kd">function </span><span class="nf">receiveObject</span><span class="o">(</span><span class="n">index</span><span class="o">:</span><span class="kt">Number</span><span class="o">):</span><span class="kt">void</span><span class="o">{</span>

        <span class="n">_netGroup</span><span class="o">.</span><span class="na">addWantObjects</span><span class="o">(</span><span class="n">index</span><span class="o">,</span><span class="n">index</span><span class="o">);</span>
        <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">actualFetchIndex</span> <span class="o">=</span> <span class="n">index</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">startReceiving</span><span class="o">():</span><span class="kt">void</span><span class="o">{</span>
        <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;startReceiving&quot;</span><span class="o">);</span>

        <span class="n">p2pSharedObject</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">P2PSharedObject</span><span class="o">();</span>
        <span class="n">p2pSharedObject</span><span class="o">.</span><span class="na">chunks</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">Object</span><span class="o">();</span>
        <span class="n">receiveObject</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">call</span><span class="o">(</span><span class="s2">&quot;onInfoRequest&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">startSharing</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">Event</span><span class="o">):</span><span class="kt">void</span><span class="o">{</span>
        <span class="n">writeText</span><span class="o">(</span><span class="s2">&quot;File loaded, startSharing - &quot;</span> <span class="o">+</span> <span class="n">_fileLoader</span><span class="o">.</span><span class="na">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span> <span class="o">+</span> <span class="s2">&quot; chunks&quot;</span><span class="o">);</span>

        <span class="n">_netGroup</span><span class="o">.</span><span class="na">addHaveObjects</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">_fileLoader</span><span class="o">.</span><span class="na">p2pSharedObject</span><span class="o">.</span><span class="na">packetLength</span><span class="o">);</span>
        <span class="n">btStartReceiving</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="n">btBrowse</span><span class="o">.</span><span class="na">enabled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">function </span><span class="nf">writeText</span><span class="o">(</span><span class="n">txt</span><span class="o">:</span><span class="kt">String</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
        <span class="n">txtHistory</span><span class="o">.</span><span class="na">text</span> <span class="o">+=</span> <span class="n">txt</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">]]&gt;</span>
  <span class="o">&lt;/</span><span class="n">fx</span><span class="o">:</span><span class="n">Script</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">VBox</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;10&quot;</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span> <span class="n">paddingBottom</span><span class="o">=</span><span class="s2">&quot;10&quot;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">HBox</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">TextInput</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;400&quot;</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;rtmfp://localhost/clients/p2p&quot;</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;address&quot;</span><span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Connect&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;connect()&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">HBox</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">HBox</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;btBrowse&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Browse and Share&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;_fileLoader.browseFileSystem();&quot;</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;btStartReceiving&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Receive&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;startReceiving();&quot;</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="o">/&gt;</span>
      <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">Button</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;btSave&quot;</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span> <span class="n">click</span><span class="o">=</span><span class="s2">&quot;saveFile();&quot;</span> <span class="n">enabled</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">HBox</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">mx</span><span class="o">:</span><span class="n">TextArea</span> <span class="n">id</span><span class="o">=</span><span class="s2">&quot;txtHistory&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;400&quot;</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;100%&quot;</span><span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">VBox</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">mx</span><span class="o">:</span><span class="n">Application</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="others">
<h2><a class="toc-backref" href="#id21">Others</a><a class="headerlink" href="#others" title="Permalink to this headline">¶</a></h2>
<div class="section" id="meeting-sample">
<h3><a class="toc-backref" href="#id22">Meeting sample</a><a class="headerlink" href="#meeting-sample" title="Permalink to this headline">¶</a></h3>
<p>The sources are available here: <a class="reference external" href="http://www.adobe.com/devnet/flashmediaserver/articles/real-time-collaboration.html">http://www.adobe.com/devnet/flashmediaserver/articles/real-time-collaboration.html</a></p>
<p>Use only the client part of these sources, and for server side create the file MonaServer/www/meeting/main.lua with the following content:</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">meeters</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">userName</span><span class="p">,</span> <span class="n">meeting</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">client</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">RTMFP&quot;</span> <span class="ow">or</span> <span class="n">client</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">RTMP&quot;</span> <span class="k">then</span>
    <span class="n">meeter</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">meeter</span><span class="p">.</span><span class="n">userName</span> <span class="o">=</span> <span class="n">userName</span>
    <span class="n">meeter</span><span class="p">.</span><span class="n">meeting</span> <span class="o">=</span> <span class="n">meeting</span>

    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User connected: &quot;</span><span class="p">,</span> <span class="n">meeter</span><span class="p">.</span><span class="n">userName</span> <span class="p">,</span> <span class="s2">&quot;</span><span class="s"> meeting: &quot;</span><span class="p">,</span> <span class="n">meeter</span><span class="p">.</span><span class="n">meeting</span><span class="p">)</span>

    <span class="n">sendParticipantUpdate</span><span class="p">(</span><span class="n">meeter</span><span class="p">.</span><span class="n">meeting</span><span class="p">)</span>
    <span class="n">meeters</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="n">meeter</span> <span class="c1">-- Add participant to the list</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onRead</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">&quot;</span> <span class="ow">and</span> <span class="n">client</span><span class="p">.</span><span class="n">protocol</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">HTTP&quot;</span> <span class="k">then</span> <span class="c1">-- If file empty =&gt; return VideoMeeting.html</span>
      <span class="k">return</span> <span class="s2">&quot;</span><span class="s">VideoMeeting.html&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">getParticipants</span><span class="p">(</span><span class="n">meeting</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">cur_client</span><span class="p">,</span> <span class="n">cur_meeter</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">meeters</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cur_meeter</span><span class="p">.</span><span class="n">meeting</span> <span class="o">==</span> <span class="n">meeting</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">cur_client</span><span class="p">.</span><span class="n">id</span> <span class="k">then</span>
          <span class="n">cur_meeter</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">rtmfp&#39;</span>
        <span class="k">end</span>
        <span class="n">cur_meeter</span><span class="p">.</span><span class="n">farID</span> <span class="o">=</span> <span class="n">cur_client</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
        <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_meeter</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">result</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">sendMessage</span><span class="p">(</span><span class="n">meeting</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cur_client</span><span class="p">,</span> <span class="n">cur_meeter</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">meeters</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">cur_meeter</span><span class="p">.</span><span class="n">meeting</span> <span class="o">==</span> <span class="n">meeting</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">cur_client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onMessage&quot;</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onDisconnection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="n">meeter</span> <span class="o">=</span> <span class="n">meeters</span><span class="p">[</span><span class="n">client</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">meeter</span> <span class="k">then</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">User disconnecting: &quot;</span><span class="o">..</span><span class="n">meeter</span><span class="p">.</span><span class="n">userName</span><span class="p">)</span>
    <span class="n">meeters</span><span class="p">[</span><span class="n">client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="n">sendParticipantUpdate</span><span class="p">(</span><span class="n">meeter</span><span class="p">.</span><span class="n">meeting</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">sendParticipantUpdate</span><span class="p">(</span><span class="n">meeting</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">cur_client</span><span class="p">,</span> <span class="n">cur_meeter</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">meeters</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cur_meeter</span><span class="p">.</span><span class="n">meeting</span> <span class="o">==</span> <span class="n">meeting</span><span class="p">)</span> <span class="k">then</span>
      <span class="n">cur_client</span><span class="p">.</span><span class="n">writer</span><span class="p">:</span><span class="n">writeInvocation</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">participantChanged&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2014, Mathieu Poux &amp; Thomas Jammet.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2b2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>